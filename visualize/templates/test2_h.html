<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link  rel = "stylesheet" href ="../static/codemirror/theme/dracula.css " >
    <link rel = "stylesheet" href = "../static/codemirror/lib/codemirror.css">
    <link rel = "stylesheet" href = "../static/codemirror/addon/fold/foldgutter.css">
    <link rel = "stylesheet" href = "../static/codemirror/addon/hint/show-hint.css">
    <link rel = "stylesheet" href = "../static/codemirror/addon/lint/lint.css">
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>

    <script src = "../static/codemirror/lib/codemirror.js"></script>
    <script src = "../static/codemirror/mode/python/python.js"></script>
    <script src = "../static/codemirror/addon/hint/show-hint.js"></script>
    <script src="../static/codemirror/addon/comment/comment.js"></script>
    <script src="../static/codemirror/addon/selection/active-line.js"></script>
    <script src="../static/codemirror/keymap/sublime.js"></script>
    <script src="../static/codemirror/addon/fold/foldcode.js"></script>
    <script src="../static/codemirror/addon/fold/foldgutter.js"></script>
    <script src="../static/codemirror/addon/fold/brace-fold.js"></script>
    <script src="../static/codemirror/addon/fold/indent-fold.js"></script>
    <script src="../static/codemirror/addon/fold/comment-fold.js"></script>
    <script src="../static/codemirror/addon/edit/closebrackets.js"></script>
    <script src="../static/codemirror/addon/edit/matchbrackets.js"></script>
    <script src = "../static/codemirror/addon/hint/python-hint.js"></script>
    <script>
        var el = document.getElementById("editor");
        var version = "# version: Python3\n\n";
        var codeAreaTip = "# please edit your code here:\n";
        var codeStart = "# code start\n\n";
        var codeEnd = "# code end\n\n";
        var code = "def solution():\n\tpass\n\n";
        var main = "if __name__ == '__main__':\n";
        var a = {{ code|safe }};
        var initValue = a[0];
    </script>
</head>
<body>
<form action="/test2_h/">
    <textarea class="cm_test" id = "code_editor" name="code"></textarea>

<script>
    var editor = {
        mode :"python" ,
        keyMap: "sublime", // Fast key style
        value: "Test Default Value",
        lineNumbers: true, // set number
        smartIndent: true, // smart indent
        indentUnit: 4, // Smart indent in 4 spaces
        indentWithTabs: true, // Smart indent with tabs
        lineWrapping: true, //
        // Add line number display, folder and syntax detector to the slot
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
        foldGutter: true, // Enable code folding in slots
        autofocus: true, // Autofocus
        matchBrackets: true, // Match end symbols, such as "],}"
        autoCloseBrackets: true, // Auto close symbol
        styleActiveLine: true, // Display the style of the selected row
        styleSelectedText: true,

    };
    var myTextArea = $(".cm_test").get(0);
    var myCodeMirror = CodeMirror.fromTextArea(myTextArea, editor);
    myCodeMirror.setOption("value", initValue);
    var a = {{ trace|safe }};
    var b = {{ code|safe }};
    var cnt = -1;
    var total_len = a.length;
    var prev_line = 0
    var prev_prev_line = 0;
    function highlightText(obj,txt){
        var tokens = myCodeMirror.getLineTokens(obj-1,true);
        var len = tokens.length;
        console.log(tokens);
        var start = CodeMirror.Pos(obj-1, tokens[0].start);
        var end = CodeMirror.Pos(obj-1, tokens[len-1].end);
        var markOptions ={
                css: "background-color: "+txt,
        };
        var mark = myCodeMirror.markText(start, end, markOptions);
    }
    function processing(obj){
        console.log(cnt);
        var result = "<table border='1'> <th>globals</th> <th>type</th> <th>value</th>";
        var len = obj.ordered_globals.length;
        for(var i=0; i<len; i++){
            if(obj.globals[obj.ordered_globals[i]][0]=="REF"){
                var part = "";
                var tmp = obj.ordered_globals[i];
                var tmp2 = obj.globals[tmp][1];
                part = "<tr> <td>"+tmp +"</td>"+"<td>"+obj.heap[tmp2][0]+"</td>"+"<td>"+obj.heap[tmp2].slice(1)+"</td> </tr>";
            }
            else{
                var part = "";
                var tmp = obj.ordered_globals[i];
                var tmp2 = obj.globals[tmp];
                part = "<tr> <td>"+tmp +"</td>"+"<td>"+typeof(tmp2)+"</td>"+"<td>"+tmp2+"</td> </tr>";
            }
            result = result + part;
        }
        result = "LINE : "+JSON.stringify(obj.line)+"<br>"
        + result+"</table>";
        highlightText(prev_prev_line,'rgba(255,255,255,0)');
        prev_prev_line = prev_line;
        highlightText(prev_line,'rgba(255,204,102)');
        prev_line = obj.line;
        highlightText(obj.line,'rgba(102,204,255)');

        return result;
    }
    function answer(obj, num, slider){
        var processed_code;
        var o = obj.parentElement;
        var newP=document.getElementById("answer");

        if(num==-1&&cnt<=0&&slider==0){
            processed_code = processing(a[cnt]);
            newP.innerHTML = processed_code;
            ShowSliderValue(cnt,0);
            o.appendChild(newP);
            return;
        }
        else if(num==1&&cnt>=total_len-1&&slider==0){
            processed_code = processing(a[cnt]);
            newP.innerHTML = processed_code+"End";
            highlightText(a[cnt]+1,'rgb(36,37,47)');
            ShowSliderValue(cnt,0);
            o.appendChild(newP);
            return;
        }
        else if(num==0&&slider==0){
            cnt=num;
            processed_code = processing(a[cnt]);
            processed_code = processing(a[cnt]);
            newP.innerHTML = processed_code;
            ShowSliderValue(cnt,0);
            o.appendChild(newP);
            return;
        }
        else if(num==100&&slider==0){
            cnt=total_len-1;
            processed_code = processing(a[cnt]);
            processed_code = processing(a[cnt]);
            newP.innerHTML = processed_code+"End";
            ShowSliderValue(cnt,0);
            o.appendChild(newP);
            return;
        }
        else{
            if(slider==0){
                console.log("NUM : "+num);
                console.log("NUM TYPE : "+typeof num);
                cnt = cnt+num;
                console.log("CNT TYPE : "+typeof cnt);

                processed_code = processing(a[cnt]);
                newP.innerHTML = processed_code;
                ShowSliderValue(cnt,0);
                o.appendChild(newP);
            }
            else if(slider==1) {
                console.log("NUM : "+num);
                cnt = num;
                processed_code = processing(a[cnt]);
                newP.innerHTML = processed_code;
                ShowSliderValue(cnt,0);
                o.appendChild(newP);
            }
        }
    }
    function ShowSliderValue(sVal, num) {
        var obValueView = document.getElementById("slider_value_view");
        var obSlider = document.getElementById("slider");
        var obj = document.getElementById("processing");
        obSlider.max = total_len-1;
        if(num==0){
            obSlider.value = sVal;
            obValueView.innerHTML = sVal;
            console.log(sVal);
        }
        if(num==1){
            obSlider.value = sVal;
            obValueView.innerHTML = sVal;
            answer(obj, Number(sVal), 1);
        }
    }
</script>
    <input type="submit" value="CONFIRM">
</form>

<hr>
<button id="processing" onclick="answer(this, 0, 0)">FIRST</button>
<button onclick="answer(this, 1, 0)">NEXT</button>
<button onclick="answer(this, -1, 0)">PREV</button>
<button onclick="answer(this, 100, 0)">LAST</button>
<p id="answer"></p>
<div class="Container" >
    <input id="slider" size=100 oninput='ShowSliderValue(this.value, 1)'  type="range" min='0' max='100' value='0'>
    <font size=2 id="slider_value_view">0</font>
    <hr>
</div>


</body>
</html>